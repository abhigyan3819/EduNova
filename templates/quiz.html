<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduAI â€“ Quiz</title>
  <style>
    /* ===== Dark Theme Base ===== */
    body {
      background-color: #0d0d0d;
      color: #e5e5e5;
      font-family: "Poppins", sans-serif;
      margin: 0;
      padding: 0 20px;
    }
    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 20px;
      background: #111;
      border-bottom: 1px solid #222;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .logo {
      font-weight: 700;
      font-size: 1.4rem;
      color: #4cc9f0;
    }
    .back-btn {
      background: #1a1a1a;
      color: #f0f0f0;
      text-decoration: none;
      padding: 10px 18px;
      border-radius: 8px;
      border: 1px solid #333;
      transition: all 0.3s;
    }
    .back-btn:hover {
      background: #0077ff;
      color: #fff;
      border-color: #0077ff;
      box-shadow: 0 0 10px rgba(0,119,255,0.4);
    }

    .container {
      max-width: 980px;
      margin: 40px auto;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 25px;
      margin-top: 30px;
      justify-items: center;
    }
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 30px 0;
      width: 220px;
      text-align: center;
      font-weight: 600;
      font-size: 1.15rem;
      color: #f5f5f5;
      border: 1px solid #2a2a2a;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    .card:hover {
      background: #222;
      border-color: #4cc9f0;
      transform: translateY(-4px);
      box-shadow: 0 0 10px rgba(76,201,240,0.25);
    }

    .hidden { display: none; }
    .loader {
      margin: 40px auto;
      text-align: center;
      font-size: 1.2rem;
      color: #999;
    }
    .quiz-section {
      margin-top: 30px;
      text-align: left;
    }
    .question-block {
      margin-bottom: 20px;
      padding: 15px;
      background: #151515;
      border-radius: 10px;
      border: 1px solid #2a2a2a;
    }
    .question-block h4 {
      margin-bottom: 10px;
      color: #4cc9f0;
    }
    .options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .option-btn {
      background: #1f1f1f;
      color: #ddd;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: left;
    }
    .option-btn:hover { background: #2a2a2a; }
    .option-btn.selected { outline: 2px solid #4cc9f0; }
    .submit-btn {
      margin-top: 30px;
      padding: 12px 26px;
      background: #0077ff;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .submit-btn:hover { background: #005ed1; }
    .result-section { margin-top: 30px; font-size: 1.2rem; }
    .correct { background: #0a3d0a !important; color: #b6ffb6 !important; }
    .wrong { background: #3d0a0a !important; color: #ffb6b6 !important; }

    /* small helper */
    .muted { color: #999; font-size: .95rem; margin-top: 8px; }

  </style>
</head>
<body>
  <nav class="navbar">
    <div class="logo">ðŸ“˜ EduAI</div>
    <a href="/" class="back-btn">Back to Home</a>
  </nav>

  <div class="container">
    <!-- Selection area -->
    <div id="selection-section">
      <h2>Select Class</h2>
      <div id="class-list" class="grid"></div>

      <h2 id="subject-heading" class="hidden">Select Subject</h2>
      <div id="subject-list" class="grid hidden"></div>

      <h2 id="subsubject-heading" class="hidden">Select Sub-Subject (if any)</h2>
      <div id="subsubject-list" class="grid hidden"></div>

      <h2 id="chapter-heading" class="hidden">Select Chapter</h2>
      <div id="chapter-list" class="grid hidden"></div>

      <div id="selection-note" class="muted hidden">Choose class â†’ subject â†’ chapter. Questions will be generated by AI.</div>
    </div>

    <!-- Loader -->
    <div id="loader" class="loader hidden">Generating quizâ€¦ please waitâ€¦</div>

    <!-- Quiz -->
    <div id="quiz-section" class="quiz-section hidden">
      <div id="quiz-meta" class="muted"></div>
      <form id="quiz-form"></form>
      <button id="submit-btn" class="submit-btn">Submit Quiz</button>
    </div>

    <!-- Results -->
    <div id="result-section" class="result-section hidden"></div>
  </div>

  <script>
    let ncertData = {};
    let selectedClass = null;
    let selectedSubject = null;
    let selectedSubSubject = null;
    let selectedChapter = null;
    let quizData = [];

    // Fetch structure from Flask
    fetch("/get_structure")
      .then(res => res.json())
      .then(data => {
        ncertData = data;
        populateClasses();
      })
      .catch(err => {
        console.error("Failed to load NCERT structure:", err);
        document.getElementById("class-list").innerHTML = '<p class="muted">Failed to load curriculum.</p>';
      });

    function clearSectionsFrom(level) {
      // levels: class, subject, subsubject, chapter
      if (level === 'class') {
        document.getElementById("subject-list").innerHTML = "";
        document.getElementById("subject-list").classList.add("hidden");
        document.getElementById("subject-heading").classList.add("hidden");
      }
      if (level === 'subject') {
        document.getElementById("subsubject-list").innerHTML = "";
        document.getElementById("subsubject-list").classList.add("hidden");
        document.getElementById("subsubject-heading").classList.add("hidden");
      }
      if (level === 'subsubject') {
        document.getElementById("chapter-list").innerHTML = "";
        document.getElementById("chapter-list").classList.add("hidden");
        document.getElementById("chapter-heading").classList.add("hidden");
      }
    }

    function populateClasses() {
      const classList = document.getElementById("class-list");
      classList.innerHTML = "";
      Object.keys(ncertData).forEach(cls => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = "Class " + cls;
        div.onclick = () => onClassClick(cls);
        classList.appendChild(div);
      });
    }

    function onClassClick(cls) {
      selectedClass = cls;
      clearSectionsFrom('class');
      // populate subjects
      const subjectList = document.getElementById("subject-list");
      subjectList.innerHTML = "";
      const subjects = ncertData[cls];
      Object.keys(subjects).forEach(subject => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = subject;
        div.onclick = () => onSubjectClick(subject);
        subjectList.appendChild(div);
      });
      document.getElementById("subject-heading").classList.remove("hidden");
      subjectList.classList.remove("hidden");
      document.getElementById("selection-note").classList.remove("hidden");
      // hide lower sections
      clearSectionsFrom('subject');
      clearSectionsFrom('subsubject');
    }

    function onSubjectClick(subject) {
      selectedSubject = subject;
      // the data for this subject may be array (chapters) or object (subsubjects)
      const subjData = ncertData[selectedClass][subject];
      clearSectionsFrom('subject');

      if (Array.isArray(subjData)) {
        // directly chapters
        showChapters(subject, subjData);
      } else if (typeof subjData === 'object') {
        // show subsubjects
        const subList = document.getElementById("subsubject-list");
        subList.innerHTML = "";
        Object.keys(subjData).forEach(sub => {
          const div = document.createElement("div");
          div.className = "card";
          div.textContent = sub;
          div.onclick = () => onSubSubjectClick(sub, subjData[sub]);
          subList.appendChild(div);
        });
        document.getElementById("subsubject-heading").classList.remove("hidden");
        subList.classList.remove("hidden");
      } else {
        console.warn("Unexpected subject data", subjData);
      }
    }

    function onSubSubjectClick(sub, chaptersArr) {
      selectedSubSubject = sub;
      clearSectionsFrom('subsubject');
      showChapters(sub, chaptersArr);
    }

    function showChapters(subjectName, chaptersArr) {
      const chapterList = document.getElementById("chapter-list");
      chapterList.innerHTML = "";
      chaptersArr.forEach(ch => {
        const div = document.createElement("div");
        div.className = "card";
        div.textContent = ch;
        div.onclick = () => onChapterClick(ch);
        chapterList.appendChild(div);
      });
      document.getElementById("chapter-heading").classList.remove("hidden");
      chapterList.classList.remove("hidden");
      selectedSubSubject = selectedSubSubject || null;
    }

    function onChapterClick(ch) {
      selectedChapter = ch;
      // start quiz flow
      document.getElementById("selection-section").classList.add("hidden");
      document.getElementById("loader").classList.remove("hidden");
      fetchQuizFromServer();
    }

    async function fetchQuizFromServer() {
      try {
        const payload = {
          class: selectedClass,
          subject: selectedSubject,
          subsubject: selectedSubSubject || null,
          chapter: selectedChapter
        };

        const res = await fetch("/gen_quiz", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (data.error) throw new Error(data.error);
        if (!Array.isArray(data.questions)) throw new Error("Invalid response from server");

        quizData = data.questions;
        renderQuiz();
      } catch (err) {
        console.error("Quiz fetch error:", err);
        alert("Failed to generate quiz. See console for details.");
        // fallback: show a tiny local sample
        quizData = [
          { question: "Fallback: Which is an acid?", options: ["NaOH","HCl","NaCl","CaCO3"], answer: "HCl" }
        ];
        renderQuiz();
      } finally {
        document.getElementById("loader").classList.add("hidden");
      }
    }

    function renderQuiz() {
      document.getElementById("quiz-meta").textContent =
        `Class ${selectedClass} Â· ${selectedSubject}` + (selectedSubSubject ? ` Â· ${selectedSubSubject}` : '') + ` Â· ${selectedChapter}`;

      const form = document.getElementById("quiz-form");
      form.innerHTML = "";
      quizData.forEach((q, idx) => {
        const block = document.createElement("div");
        block.className = "question-block";
        const h4 = document.createElement("h4");
        h4.textContent = (idx + 1) + ". " + q.question;
        block.appendChild(h4);

        const opts = document.createElement("div");
        opts.className = "options";

        q.options.forEach(opt => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "option-btn";
          btn.textContent = opt;
          btn.onclick = () => {
            // deselect siblings
            btn.parentElement.querySelectorAll(".option-btn").forEach(b => b.classList.remove("selected"));
            btn.classList.add("selected");
            q.userAnswer = opt;
          };
          opts.appendChild(btn);
        });

        block.appendChild(opts);
        form.appendChild(block);
      });

      document.getElementById("quiz-section").classList.remove("hidden");
      document.getElementById("submit-btn").onclick = submitQuiz;
      // scroll to quiz
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function submitQuiz() {
      let score = 0;
      quizData.forEach((q, idx) => {
        const block = document.getElementById("quiz-form").children[idx];
        const btns = block.querySelectorAll(".option-btn");
        btns.forEach(btn => {
          // mark correct / wrong
          if (btn.textContent.trim() === q.answer.trim()) {
            btn.classList.add("correct");
          } else if (btn.classList.contains("selected")) {
            btn.classList.add("wrong");
          }
          btn.disabled = true;
        });
        if (q.userAnswer && q.userAnswer.trim() === q.answer.trim()) score++;
      });
      const result = document.getElementById("result-section");
      result.innerHTML = `You scored <strong>${score}</strong> out of <strong>${quizData.length}</strong>.`;
      result.classList.remove("hidden");
      document.getElementById("submit-btn").disabled = true;
    }
    function onClassClick(cls) {
  selectedClass = cls;

  // Hide class section
  document.getElementById("class-list").classList.add("hidden");

  // Reset lower sections
  clearSectionsFrom('class');

  // Populate subjects
  const subjectList = document.getElementById("subject-list");
  subjectList.innerHTML = "";
  const subjects = ncertData[cls];
  Object.keys(subjects).forEach(subject => {
    const div = document.createElement("div");
    div.className = "card";
    div.textContent = subject;
    div.onclick = () => onSubjectClick(subject);
    subjectList.appendChild(div);
  });

  document.getElementById("subject-heading").classList.remove("hidden");
  subjectList.classList.remove("hidden");
  document.getElementById("selection-note").classList.remove("hidden");
}

function onSubjectClick(subject) {
  selectedSubject = subject;

  // Hide subject section
  document.getElementById("subject-list").classList.add("hidden");
  document.getElementById("subject-heading").classList.add("hidden");

  const subjData = ncertData[selectedClass][subject];
  clearSectionsFrom('subject');

  if (Array.isArray(subjData)) {
    // Directly chapters
    showChapters(subject, subjData);
  } else if (typeof subjData === 'object') {
    // Show sub-subjects
    const subList = document.getElementById("subsubject-list");
    subList.innerHTML = "";
    Object.keys(subjData).forEach(sub => {
      const div = document.createElement("div");
      div.className = "card";
      div.textContent = sub;
      div.onclick = () => onSubSubjectClick(sub, subjData[sub]);
      subList.appendChild(div);
    });
    document.getElementById("subsubject-heading").classList.remove("hidden");
    subList.classList.remove("hidden");
  }
}

function onSubSubjectClick(sub, chaptersArr) {
  selectedSubSubject = sub;

  // Hide subsubject section
  document.getElementById("subsubject-list").classList.add("hidden");
  document.getElementById("subsubject-heading").classList.add("hidden");

  clearSectionsFrom('subsubject');
  showChapters(sub, chaptersArr);
}

function showChapters(subjectName, chaptersArr) {
  const chapterList = document.getElementById("chapter-list");
  chapterList.innerHTML = "";

  // Hide any previous section
  document.getElementById("chapter-heading").classList.remove("hidden");
  chapterList.classList.remove("hidden");

  chaptersArr.forEach(ch => {
    const div = document.createElement("div");
    div.className = "card";
    div.textContent = ch;
    div.onclick = () => onChapterClick(ch);
    chapterList.appendChild(div);
  });
}

  </script>
</body>
</html>
